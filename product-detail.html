<!DOCTYPE html>
<!--
================================================================================
PRODUCT-DETAIL.HTML - Trang Chi ti·∫øt S·∫£n ph·∫©m
================================================================================

Ch·ª©c nƒÉng:
- Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt s·∫£n ph·∫©m (t√™n, m√¥ t·∫£, ƒë√°nh gi√°)
- Cho ph√©p ch·ªçn size v√† topping
- T√πy ch·ªânh s·ªë l∆∞·ª£ng
- Hi·ªÉn th·ªã gi√° t·ªïng ƒë·ªông (thay ƒë·ªïi khi ch·ªçn option)
- Th√™m v√†o y√™u th√≠ch
- Th√™m v√†o gi·ªè h√†ng

URL Format: product-detail.html?id=PRODUCT_ID

C√°c element quan tr·ªçng (ID):
- productDetail: Container ch√≠nh ch·ª©a th√¥ng tin s·∫£n ph·∫©m
- sizeOptions: Container cho c√°c option size
- toppingOptions: Container cho c√°c option topping
- builderQuantity: Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng
- priceBreakdown: B·∫£ng chi ti·∫øt gi√°
- totalPrice: Hi·ªÉn th·ªã t·ªïng ti·ªÅn
- favoriteBtn: N√∫t y√™u th√≠ch
================================================================================
-->
<html lang="vi">
  <head>
    <!-- ===== META TAGS ===== -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Title s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JavaScript v·ªõi t√™n s·∫£n ph·∫©m -->
    <title>Chi ti·∫øt s·∫£n ph·∫©m - Kvone Coffee</title>
    <meta
      name="description"
      content="Xem chi ti·∫øt v√† t√πy ch·ªânh ƒë·ªì u·ªëng theo √Ω th√≠ch c·ªßa b·∫°n"
    />
    <link rel="icon" type="image/png" href="menu/icons/coffee.png" />

    <!-- View Transitions API -->
    <meta name="view-transition" content="same-origin" />
    <meta name="theme-color" content="#54372b" />

    <!-- ===== CSS ===== -->
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/main.css" />
  </head>

  <body>
    <div class="page-wrapper">
      <!-- 
        =====================================================================
        HEADER - Gi·ªëng c√°c trang kh√°c
        =====================================================================
        -->
      <header class="header">
        <div class="header-container">
          <a href="index.html" class="logo">
            <span class="logo-icon">‚òï</span>
            <span>Kvone Coffee</span>
          </a>

          <nav class="nav" id="mainNav">
            <a href="index.html" class="nav-link">Menu</a>
            <a href="favorites.html" class="nav-link">Y√™u th√≠ch</a>
            <a href="orders.html" class="nav-link">ƒê∆°n h√†ng</a>
          </nav>

          <div class="header-actions">
            <a href="cart.html" class="cart-btn">
              üõí
              <span class="cart-badge" style="display: none">0</span>
            </a>

            <div
              class="user-menu"
              id="userMenu"
              style="display: none"
              onclick="toggleUserDropdown()"
            >
              <div class="avatar">U</div>
              <span class="user-name">User</span>
            </div>

            <div id="authLinks" style="display: flex; gap: var(--space-2)">
              <a href="login.html" class="btn btn-ghost btn-sm">ƒêƒÉng nh·∫≠p</a>
              <a href="register.html" class="btn btn-secondary btn-sm"
                >ƒêƒÉng k√Ω</a
              >
            </div>

            <button class="mobile-menu-btn btn btn-ghost" id="mobileMenuBtn" onclick="document.querySelector('.nav').classList.toggle('active')">
              ‚ò∞
            </button>
          </div>
        </div>
      </header>

      <!-- 
        =====================================================================
        MAIN CONTENT
        =====================================================================
        -->
      <main class="main-content">
        <div class="container">
          <!-- 
                Breadcrumb - Link quay l·∫°i menu
                Gi√∫p user d·ªÖ d√†ng quay l·∫°i danh s√°ch s·∫£n ph·∫©m
                -->
          <div style="padding: var(--space-4) 0">
            <a href="index.html" style="color: var(--color-text-muted)"
              >‚Üê Quay l·∫°i menu</a
            >
          </div>

          <!-- 
                PRODUCT DETAIL Container
                N·ªôi dung ƒë∆∞·ª£c render ƒë·ªông b·∫±ng JavaScript
                Bao g·ªìm: h√¨nh ·∫£nh, th√¥ng tin, options, n√∫t th√™m gi·ªè
                -->
          <div class="product-detail" id="productDetail">
            <!-- Render b·∫±ng JavaScript trong renderProductDetail() -->
          </div>
        </div>
      </main>

      <!-- 
        =====================================================================
        FOOTER
        =====================================================================
        -->
      <footer class="footer">
        <div class="footer-container">
          <div class="footer-brand">
            <div class="footer-logo">
              <span>‚òï</span>
              <span>Kvone Coffee</span>
            </div>
            <p class="footer-desc">
              N∆°i m·ªói ly c√† ph√™ l√† m·ªôt t√°c ph·∫©m ngh·ªá thu·∫≠t, ƒë∆∞·ª£c pha ch·∫ø v·ªõi
              t√¨nh y√™u v√† s·ª± t·∫≠n t√¢m.
            </p>
          </div>

          <div>
            <h4 class="footer-title">Li√™n k·∫øt</h4>
            <div class="footer-links">
              <a href="index.html" class="footer-link">‚òï Menu</a>
              <a href="favorites.html" class="footer-link">üíï Y√™u th√≠ch</a>
              <a href="orders.html" class="footer-link">üìã ƒê∆°n h√†ng</a>
            </div>
          </div>

          <div>
            <h4 class="footer-title">Li√™n h·ªá</h4>
            <div class="footer-links">
              <span class="footer-link">üìç Nguy·ªÖn VƒÉn Linh, ƒê√† N·∫µng</span>
              <span class="footer-link">üìû 0905580275</span>
              <span class="footer-link">‚úâÔ∏è kvonecoffee@gmail.com</span>
              <span class="footer-link">‚è∞ 7:00 - 22:00 h√†ng ng√†y</span>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          ¬© 2024 Kvone Coffee. Made with ‚ù§Ô∏è for coffee lovers.
        </div>
      </footer>
    </div>

    <!-- 
    =========================================================================
    USER DROPDOWN MENU
    =========================================================================
    -->
    <div
      id="userDropdown"
      class="card"
      style="
        display: none;
        position: fixed;
        top: 70px;
        right: 100px;
        min-width: 220px;
        z-index: 1000;
        box-shadow: var(--shadow-2xl);
      "
    >
      <div class="card-body" style="padding: var(--space-2)">
        <a
          href="orders.html"
          class="btn btn-ghost w-full"
          style="justify-content: flex-start; gap: var(--space-3)"
          >üìã ƒê∆°n h√†ng c·ªßa t√¥i</a
        >
        <a
          href="favorites.html"
          class="btn btn-ghost w-full"
          style="justify-content: flex-start; gap: var(--space-3)"
          >‚ù§Ô∏è Y√™u th√≠ch</a
        >
        <a
          href="admin.html"
          id="adminLink"
          class="btn btn-ghost w-full"
          style="
            display: none;
            justify-content: flex-start;
            gap: var(--space-3);
            color: var(--color-primary);
          "
        >
          ‚öôÔ∏è Qu·∫£n l√Ω Admin
        </a>
        <div class="divider" style="margin: var(--space-2) 0"></div>
        <button
          class="btn btn-ghost w-full"
          style="
            justify-content: flex-start;
            gap: var(--space-3);
            color: var(--color-error);
          "
          onclick="logout()"
        >
          üö™ ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>

    <!-- 
    =========================================================================
    JAVASCRIPT FILES
    L∆∞u √Ω: C·∫ßn load builder.js cho trang n√†y
    =========================================================================
    -->
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/products.js"></script>
    <script src="js/sizes.js"></script>
    <script src="js/toppings.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/favorites.js"></script>
    <script src="js/reviews.js"></script>
    <!-- Reviews cho ƒë√°nh gi√° s·∫£n ph·∫©m -->
    <script src="js/builder.js"></script>
    <!-- Builder cho trang chi ti·∫øt -->
    <script src="js/app.js"></script>
    <script src="js/enhancements.js"></script>

    <!-- 
    =========================================================================
    INLINE JAVASCRIPT
    =========================================================================
    -->
    <script>
      // =====================================================================
      // TOGGLE USER DROPDOWN
      // =====================================================================
      function toggleUserDropdown() {
        const dropdown = document.getElementById("userDropdown");
        dropdown.style.display =
          dropdown.style.display === "none" ? "block" : "none";
      }

      // =====================================================================
      // CLICK OUTSIDE TO CLOSE DROPDOWN
      // =====================================================================
      document.addEventListener("click", function (e) {
        const userMenu = document.getElementById("userMenu");
        const dropdown = document.getElementById("userDropdown");

        if (!userMenu?.contains(e.target) && !dropdown?.contains(e.target)) {
          if (dropdown) dropdown.style.display = "none";
        }
      });

      // =====================================================================
      // DOM CONTENT LOADED
      // =====================================================================
      document.addEventListener("DOMContentLoaded", function () {
        // Kh·ªüi t·∫°o app
        initApp();

        // Hi·ªÉn th·ªã Admin link n·∫øu l√† admin
        if (isAdmin()) {
          const adminLink = document.getElementById("adminLink");
          if (adminLink) adminLink.style.display = "flex";
        }

        // ===== L·∫§Y PRODUCT ID T·ª™ URL =====
        // URL format: product-detail.html?id=p123
        const productId = getUrlParam("id");

        // N·∫øu kh√¥ng c√≥ ID, redirect v·ªÅ menu
        if (!productId) {
          window.location.href = "index.html";
          return;
        }

        // Render chi ti·∫øt s·∫£n ph·∫©m
        renderProductDetail(productId);
      });

      // =====================================================================
      // RENDER PRODUCT DETAIL - V·∫Ω giao di·ªán chi ti·∫øt s·∫£n ph·∫©m
      // =====================================================================
      function renderProductDetail(productId) {
        const container = document.getElementById("productDetail");

        // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ storage
        const product = getProductById(productId);

        // ===== S·∫¢N PH·∫®M KH√îNG T·ªíN T·∫†I =====
        if (!product) {
          container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üòï</div>
                        <h3 class="empty-state-title">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h3>
                        <p class="empty-state-text">S·∫£n ph·∫©m n√†y kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</p>
                        <a href="index.html" class="btn btn-primary">Quay l·∫°i menu</a>
                    </div>
                `;
          return;
        }

        // ===== C·∫¨P NH·∫¨T TITLE TRANG =====
        document.title = `${product.name} - Kvone Coffee`;

        // ===== KI·ªÇM TRA H√åNH ·∫¢NH =====
        const isImageUrl =
          product.image &&
          (product.image.startsWith("data:") ||
            product.image.startsWith("http") ||
            product.image.includes("/"));
        const imageHtml = isImageUrl
          ? `<img src="${product.image}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;">`
          : product.image;

        // ===== RENDER HTML CHO S·∫¢N PH·∫®M =====
        container.innerHTML = `
                <!-- 
                H√åNH ·∫¢NH S·∫¢N PH·∫®M
                K·∫øt h·ª£p v·ªõi n√∫t y√™u th√≠ch ·ªü g√≥c
                -->
                <div class="product-detail-image">
                    ${imageHtml}
                    <!-- 
                    N√öT Y√äU TH√çCH
                    class 'active' khi ƒë√£ th√™m v√†o favorites
                    onclick toggle v√† c·∫≠p nh·∫≠t button
                    -->
                    <button class="favorite-btn ${
                      isFavorite(product.id) ? "active" : ""
                    }" 
                            onclick="toggleFavorite('${
                              product.id
                            }'); updateFavoriteBtn();"
                            id="favoriteBtn">
                        ${isFavorite(product.id) ? "‚ù§Ô∏è" : "ü§ç"}
                    </button>
                </div>

                <!-- TH√îNG TIN V√Ä T√ôY CH·ªåN -->
                <div class="product-detail-info">
                    <!-- Th√¥ng tin c∆° b·∫£n -->
                    <div>
                        <!-- 
                        RATING HEADER - Dynamic t·ª´ reviews.js
                        D√πng renderStars() ƒë·ªÉ hi·ªÉn th·ªã sao c√≥ m√†u
                        - Ch∆∞a ƒë√°nh gi√°: ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ (5 sao r·ªóng x√°m)
                        - C√≥ ƒë√°nh gi√°: ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ ho·∫∑c ‚òÖ‚òÖ‚òÖ‚òÖ¬Ω (v√†ng)
                        -->
                        <div class="rating" id="headerRating" style="margin-bottom: var(--space-2);">
                            <div class="rating-stars">${
                                typeof renderStars === 'function' 
                                    ? renderStars(
                                        typeof getAverageRating === 'function' 
                                            ? getAverageRating(product.id) 
                                            : 0
                                      )
                                    : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'
                            }</div>
                            <span class="rating-count">(${
                                typeof getReviewCount === 'function' 
                                    ? getReviewCount(product.id) 
                                    : 0
                            } ƒë√°nh gi√°)</span>
                        </div>
                        <!-- T√™n s·∫£n ph·∫©m -->
                        <h1 class="product-detail-name">${product.name}</h1>
                        <!-- M√¥ t·∫£ -->
                        <p class="product-detail-desc">${
                          product.description
                        }</p>
                    </div>

                    <!-- 
                    BUILDER SECTION: CH·ªåN SIZE
                    N·ªôi dung render b·ªüi builder.js -> renderSizeOptions()
                    -->
                    <div class="builder-section">
                        <h3 class="builder-section-title">üìê Ch·ªçn Size</h3>
                        <div id="sizeOptions">
                            <!-- Render b·∫±ng JS -->
                        </div>
                    </div>

                    <!-- 
                    BUILDER SECTION: CH·ªåN TOPPING
                    N·ªôi dung render b·ªüi builder.js -> renderToppingOptions()
                    -->
                    <div class="builder-section">
                        <h3 class="builder-section-title">üßÅ Ch·ªçn Topping</h3>
                        <div id="toppingOptions">
                            <!-- Render b·∫±ng JS -->
                        </div>
                    </div>

                    <!-- 
                    BUILDER SECTION: S·ªê L∆Ø·ª¢NG
                    N√∫t +/- ƒë·ªÉ thay ƒë·ªïi
                    -->
                    <div class="builder-section">
                        <h3 class="builder-section-title">üì¶ S·ªë l∆∞·ª£ng</h3>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="handleBuilderQuantity(-1)">‚àí</button>
                            <span class="quantity-value" id="builderQuantity">1</span>
                            <button class="quantity-btn" onclick="handleBuilderQuantity(1)">+</button>
                        </div>
                    </div>

                    <!-- 
                    B·∫¢NG CHI TI·∫æT GI√Å
                    Hi·ªÉn th·ªã: gi√° g·ªëc, gi√° size, gi√° topping, t·ªïng
                    C·∫≠p nh·∫≠t ƒë·ªông b·ªüi builder.js -> updatePriceDisplay()
                    -->
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Render b·∫±ng JS -->
                    </div>

                    <!-- 
                    N√öT TH√äM V√ÄO GI·ªé
                    G·ªçi addToCartFromBuilder() t·ª´ builder.js
                    Hi·ªÉn th·ªã t·ªïng ti·ªÅn tr√™n n√∫t
                    -->
                    <button class="btn btn-primary btn-lg w-full" onclick="addToCartFromBuilder()">
                        üõí Th√™m v√†o gi·ªè h√†ng - <span id="totalPrice">0ƒë</span>
                    </button>
                </div>

                <!-- 
                REVIEWS SECTION - Full width d∆∞·ªõi 2 c·ªôt
                Di chuy·ªÉn ra ngo√†i product-detail-info ƒë·ªÉ c√¢n b·∫±ng layout
                -->
                <div id="reviewsSection" style="grid-column: 1 / -1;"></div>
            `;

        // ===== KH·ªûI T·∫†O BUILDER =====
        // Sau khi render HTML xong, g·ªçi initBuilder ƒë·ªÉ setup logic
        initBuilder(productId);

        // ===== RENDER REVIEWS =====
        // Render form ƒë√°nh gi√° v√† danh s√°ch reviews
        const reviewsContainer = document.getElementById('reviewsSection');
        if (reviewsContainer && typeof renderReviewsSection === 'function') {
            renderReviewsSection(reviewsContainer, productId);
        }
      }

      // =====================================================================
      // UPDATE FAVORITE BUTTON - C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t y√™u th√≠ch
      // =====================================================================
      function updateFavoriteBtn() {
        const productId = getUrlParam("id");
        const btn = document.getElementById("favoriteBtn");

        if (btn) {
          const isFav = isFavorite(productId);
          // Toggle class active
          btn.classList.toggle("active", isFav);
          // Thay ƒë·ªïi icon
          btn.innerHTML = isFav ? "‚ù§Ô∏è" : "ü§ç";
        }
      }
    </script>
  </body>
</html>
