<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh to√°n - Kvone Coffee</title>
    <meta name="description" content="Ho√†n t·∫•t ƒë∆°n h√†ng c·ªßa b·∫°n" />
    <link rel="icon" type="image/png" href="menu/icons/coffee.png" />

    <!-- View Transitions API -->
    <meta name="view-transition" content="same-origin" />
    <meta name="theme-color" content="#54372b" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/main.css" />
  </head>

  <body>
    <div class="page-wrapper">
      <!-- Header - CHU·∫®N gi·ªëng c√°c trang kh√°c -->
      <header class="header">
        <div class="header-container">
          <a href="index.html" class="logo">
            <span class="logo-icon">‚òï</span>
            <span>Kvone Coffee</span>
          </a>

          <nav class="nav">
            <a href="index.html" class="nav-link">Menu</a>
            <a href="favorites.html" class="nav-link">Y√™u th√≠ch</a>
            <a href="orders.html" class="nav-link">ƒê∆°n h√†ng</a>
          </nav>

          <div class="header-actions">
            <!-- Cart Button -->
            <a href="cart.html" class="cart-btn">
              üõí
              <span class="cart-badge" style="display: none">0</span>
            </a>
            
            <div
              class="user-menu"
              id="userMenu"
              style="display: none"
              onclick="toggleUserDropdown()"
            >
              <div class="avatar">U</div>
              <span class="user-name">User</span>
            </div>
          </div>
        </div>
      </header>

      <main class="main-content">
        <div
          class="container"
          style="padding: var(--space-8) var(--container-padding)"
        >
          <!-- Link quay l·∫°i gi·ªè h√†ng -->
          <a href="cart.html" style="
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--color-primary);
            text-decoration: none;
            margin-bottom: var(--space-4);
            font-size: var(--text-sm);
          ">
            ‚Üê Quay l·∫°i gi·ªè h√†ng
          </a>
          
          <h1 style="margin-bottom: var(--space-6)">üí≥ Thanh to√°n</h1>

          <div class="checkout-grid">
            <!-- Form th√¥ng tin -->
            <div>
              <!-- Th√¥ng tin kh√°ch h√†ng -->
              <div class="checkout-section">
                <h3 class="checkout-section-title">üë§ Th√¥ng tin kh√°ch h√†ng</h3>
                <form id="checkoutForm">
                  <div class="form-group">
                    <label class="form-label" for="customerName"
                      >H·ªç v√† t√™n *</label
                    >
                    <input
                      type="text"
                      class="form-input"
                      id="customerName"
                      name="name"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="phone"
                      >S·ªë ƒëi·ªán tho·∫°i *</label
                    >
                    <input
                      type="tel"
                      class="form-input"
                      id="phone"
                      name="phone"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="address">ƒê·ªãa ch·ªâ</label>
                    <textarea
                      class="form-input form-textarea"
                      id="address"
                      name="address"
                      placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ n·∫øu ch·ªçn mang ƒëi"
                    ></textarea>
                  </div>
                </form>
              </div>

              <!-- H√¨nh th·ª©c nh·∫≠n h√†ng -->
              <div class="checkout-section">
                <h3 class="checkout-section-title">üöó H√¨nh th·ª©c nh·∫≠n h√†ng</h3>
                <div style="display: flex; gap: var(--space-4)">
                  <label
                    class="form-check"
                    style="
                      flex: 1;
                      padding: var(--space-4);
                      background: var(--color-background);
                      border-radius: var(--radius-lg);
                      border: 2px solid var(--color-border);
                    "
                  >
                    <input
                      type="radio"
                      name="delivery"
                      value="dine-in"
                      class="form-check-input"
                      checked
                    />
                    <span>üè† U·ªëng t·∫°i qu√°n</span>
                  </label>
                  <label
                    class="form-check"
                    style="
                      flex: 1;
                      padding: var(--space-4);
                      background: var(--color-background);
                      border-radius: var(--radius-lg);
                      border: 2px solid var(--color-border);
                    "
                  >
                    <input
                      type="radio"
                      name="delivery"
                      value="takeaway"
                      class="form-check-input"
                    />
                    <span>üöó Mang ƒëi</span>
                  </label>
                </div>
              </div>

              <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
              <div class="checkout-section">
                <h3 class="checkout-section-title">
                  üí∞ Ph∆∞∆°ng th·ª©c thanh to√°n
                </h3>
                <div style="display: flex; gap: var(--space-4)">
                  <label
                    class="form-check"
                    style="
                      flex: 1;
                      padding: var(--space-4);
                      background: var(--color-background);
                      border-radius: var(--radius-lg);
                      border: 2px solid var(--color-border);
                    "
                  >
                    <input
                      type="radio"
                      name="payment"
                      value="cash"
                      class="form-check-input"
                      checked
                    />
                    <span>üíµ Ti·ªÅn m·∫∑t</span>
                  </label>
                  <label
                    class="form-check"
                    style="
                      flex: 1;
                      padding: var(--space-4);
                      background: var(--color-background);
                      border-radius: var(--radius-lg);
                      border: 2px solid var(--color-border);
                    "
                  >
                    <input
                      type="radio"
                      name="payment"
                      value="qr"
                      class="form-check-input"
                    />
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <img src="https://cdn.brandfetch.io/momo.vn/w/512/h/512?c=1idiRamKWOLozA0BjjR" 
                           alt="MoMo" 
                           style="width: 20px; height: 20px; border-radius: 4px;"
                           onerror="this.outerHTML='üì±'">
                      MoMo
                    </span>
                  </label>
                </div>
              </div>
            </div>

            <!-- T√≥m t·∫Øt ƒë∆°n h√†ng -->
            <div>
              <div
                class="checkout-section"
                style="position: sticky; top: 100px"
              >
                <h3 class="checkout-section-title">üìã ƒê∆°n h√†ng c·ªßa b·∫°n</h3>

                <div id="orderSummary">
                  <!-- Render b·∫±ng JS -->
                </div>

                <div class="divider"></div>

                <div class="price-breakdown">
                  <div class="price-row total">
                    <span>T·ªïng c·ªông</span>
                    <span id="totalPrice">0ƒë</span>
                  </div>
                </div>

                <button
                  class="btn btn-primary btn-lg w-full"
                  style="margin-top: var(--space-4)"
                  onclick="handleCheckout()"
                >
                  üéâ ƒê·∫∑t h√†ng
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="footer">
        <div class="footer-container">
          <div class="footer-brand">
            <div class="footer-logo">
              <span>‚òï</span>
              <span>Kvone Coffee</span>
            </div>
            <p class="footer-desc">
              N∆°i m·ªói ly c√† ph√™ l√† m·ªôt t√°c ph·∫©m ngh·ªá thu·∫≠t, ƒë∆∞·ª£c pha ch·∫ø v·ªõi
              t√¨nh y√™u v√† s·ª± t·∫≠n t√¢m.
            </p>
          </div>

          <div>
            <h4 class="footer-title">Li√™n k·∫øt</h4>
            <div class="footer-links">
              <a href="index.html" class="footer-link">‚òï Menu</a>
              <a href="favorites.html" class="footer-link">üíï Y√™u th√≠ch</a>
              <a href="orders.html" class="footer-link">üìã ƒê∆°n h√†ng</a>
            </div>
          </div>

          <div>
            <h4 class="footer-title">Li√™n h·ªá</h4>
            <div class="footer-links">
              <span class="footer-link">üìç Nguy·ªÖn VƒÉn Linh, ƒê√† N·∫µng</span>
              <span class="footer-link">üìû 0905580275</span>
              <span class="footer-link">‚úâÔ∏è kvonecoffee@gmail.com</span>
              <span class="footer-link">‚è∞ 7:00 - 22:00 h√†ng ng√†y</span>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          ¬© 2024 Kvone Coffee. Made with ‚ù§Ô∏è for coffee lovers.
        </div>
      </footer>
    </div>

    <!-- User Dropdown Menu -->
    <div
      id="userDropdown"
      class="card"
      style="
        display: none;
        position: fixed;
        top: 70px;
        right: 100px;
        min-width: 220px;
        z-index: 1000;
        box-shadow: var(--shadow-2xl);
      "
    >
      <div class="card-body" style="padding: var(--space-2)">
        <a
          href="orders.html"
          class="btn btn-ghost w-full"
          style="justify-content: flex-start; gap: var(--space-3)"
          >üìã ƒê∆°n h√†ng c·ªßa t√¥i</a
        >
        <a
          href="favorites.html"
          class="btn btn-ghost w-full"
          style="justify-content: flex-start; gap: var(--space-3)"
          >‚ù§Ô∏è Y√™u th√≠ch</a
        >
        <a
          href="admin.html"
          id="adminLink"
          class="btn btn-ghost w-full"
          style="
            display: none;
            justify-content: flex-start;
            gap: var(--space-3);
            color: var(--color-primary);
          "
        >
          ‚öôÔ∏è Qu·∫£n l√Ω Admin
        </a>
        <div class="divider" style="margin: var(--space-2) 0"></div>
        <button
          class="btn btn-ghost w-full"
          style="
            justify-content: flex-start;
            gap: var(--space-3);
            color: var(--color-error);
          "
          onclick="logout()"
        >
          üö™ ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/products.js"></script>
    <script src="js/sizes.js"></script>
    <script src="js/toppings.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/favorites.js"></script>
    <!-- Inventory System (Phase 1) - Required for auto-export on checkout -->
    <script src="js/inventory/ingredients.js"></script>
    <script src="js/inventory/recipes.js"></script>
    <script src="js/orders.js"></script>
    <script src="js/app.js"></script>
    <script src="js/enhancements.js"></script>
    <script>
      // Toggle user dropdown
      function toggleUserDropdown() {
        const dropdown = document.getElementById("userDropdown");
        dropdown.style.display =
          dropdown.style.display === "none" ? "block" : "none";
      }

      // ƒê√≥ng dropdown khi click b√™n ngo√†i
      document.addEventListener("click", function (e) {
        const userMenu = document.getElementById("userMenu");
        const dropdown = document.getElementById("userDropdown");

        if (!userMenu?.contains(e.target) && !dropdown?.contains(e.target)) {
          if (dropdown) dropdown.style.display = "none";
        }
      });

      // Kh·ªüi t·∫°o trang
      document.addEventListener("DOMContentLoaded", function () {
        initApp();

        // Hi·ªÉn th·ªã Admin link n·∫øu l√† admin
        if (isAdmin()) {
          const adminLink = document.getElementById("adminLink");
          if (adminLink) adminLink.style.display = "flex";
        }

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        if (!requireAuth()) return;

        // Ki·ªÉm tra gi·ªè h√†ng
        const cart = getCart();
        if (cart.length === 0) {
          window.location.href = "cart.html";
          return;
        }

        // Render t√≥m t·∫Øt ƒë∆°n h√†ng
        renderOrderSummary();

        // ƒêi·ªÅn th√¥ng tin user
        prefillUserInfo();
      });

      // Render t√≥m t·∫Øt ƒë∆°n h√†ng
      function renderOrderSummary() {
        const cart = getCart();
        const container = document.getElementById("orderSummary");
        const totalEl = document.getElementById("totalPrice");

        container.innerHTML = cart
          .map(
            (item) => `
                <div style="display: flex; justify-content: space-between; padding: var(--space-2) 0; font-size: var(--text-sm);">
                    <div>
                        <span>${item.productName}</span>
                        ${
                          item.sizeName
                            ? `<span class="text-muted"> (${item.sizeName})</span>`
                            : ""
                        }
                        <span class="text-muted"> x${item.quantity}</span>
                    </div>
                    <span class="price">${formatCurrency(
                      item.totalPrice
                    )}</span>
                </div>
            `
          )
          .join("");

        totalEl.textContent = formatCurrency(calculateTotal());
      }

      // ƒêi·ªÅn s·∫µn th√¥ng tin user
      function prefillUserInfo() {
        const user = getCurrentUser();
        if (user) {
          document.getElementById("customerName").value = user.name || "";
          document.getElementById("phone").value = user.phone || "";
          document.getElementById("address").value = user.address || "";
        }
      }

      // ==========================================================================
      // X·ª¨ L√ù ƒê·∫∂T H√ÄNG - CHECKOUT HANDLER
      // ==========================================================================
      
      /**
       * X·ª≠ l√Ω khi user click "ƒê·∫∑t h√†ng"
       * 
       * Flow:
       * 1. Validate th√¥ng tin kh√°ch h√†ng (t√™n, SƒêT, ƒë·ªãa ch·ªâ n·∫øu mang ƒëi)
       * 2. T·∫°o ƒë∆°n h√†ng v·ªõi tr·∫°ng th√°i pending
       * 3. N·∫øu ch·ªçn thanh to√°n QR -> Hi·ªán modal MoMo v·ªõi countdown 15s
       * 4. N·∫øu ch·ªçn ti·ªÅn m·∫∑t -> Ho√†n t·∫•t ngay
       */
      function handleCheckout() {
        // ========== L·∫§Y D·ªÆ LI·ªÜU T·ª™ FORM ==========
        const name = document.getElementById("customerName").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const address = document.getElementById("address").value.trim();
        
        // L·∫•y ph∆∞∆°ng th·ª©c nh·∫≠n h√†ng (dine-in ho·∫∑c takeaway)
        const deliveryMethod = document.querySelector(
          'input[name="delivery"]:checked'
        ).value;
        
        // L·∫•y ph∆∞∆°ng th·ª©c thanh to√°n (cash ho·∫∑c qr)
        const paymentMethod = document.querySelector(
          'input[name="payment"]:checked'
        ).value;

        // ========== VALIDATION ==========
        
        // Ki·ªÉm tra t√™n v√† SƒêT b·∫Øt bu·ªôc
        if (!name || !phone) {
          showNotification("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.", "error");
          return;
        }

        // Validate s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam
        // Format: 10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0 ho·∫∑c +84
        // V√≠ d·ª•: 0901234567 ho·∫∑c +84901234567
        const phoneRegex = /^(0|\+84)\d{9}$/;
        if (!phoneRegex.test(phone)) {
          showNotification(
            "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! (Ph·∫£i c√≥ 10 s·ªë)",
            "error"
          );
          return;
        }

        // N·∫øu ch·ªçn "Mang ƒëi" th√¨ b·∫Øt bu·ªôc nh·∫≠p ƒë·ªãa ch·ªâ
        if (deliveryMethod === "takeaway" && !address) {
          showNotification("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.", "error");
          return;
        }

        // ========== X·ª¨ L√ù THEO PH∆Ø∆†NG TH·ª®C THANH TO√ÅN ==========
        
        if (paymentMethod === "qr") {
          // ========== THANH TO√ÅN MOMO ==========
          /**
           * QUAN TR·ªåNG: Khi ch·ªçn MoMo, CH∆ØA t·∫°o ƒë∆°n h√†ng ngay!
           * 
           * Flow m·ªõi:
           * 1. L∆∞u th√¥ng tin form t·∫°m th·ªùi
           * 2. Hi·ªán modal MoMo
           * 3. N·∫øu thanh to√°n th√†nh c√¥ng -> T·∫°o ƒë∆°n h√†ng
           * 4. N·∫øu h·ªßy -> ƒê√≥ng modal, gi·ªØ nguy√™n form ƒë·ªÉ ƒë·ªïi ph∆∞∆°ng th·ª©c
           */
          showMoMoPayment({
            customerInfo: { name, phone, address },
            deliveryMethod: deliveryMethod,
            paymentMethod: paymentMethod
          });
        } else {
          // ========== THANH TO√ÅN TI·ªÄN M·∫∂T ==========
          // T·∫°o ƒë∆°n h√†ng ngay
          const result = createOrder(
            { name, phone, address },
            deliveryMethod,
            paymentMethod
          );

          // Ki·ªÉm tra k·∫øt qu·∫£ t·∫°o ƒë∆°n
          if (!result.success) {
            showNotification(result.message, "error");
            return;
          }

          // Th√¥ng b√°o th√†nh c√¥ng
          showNotification(
            "üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n: " + result.order.id,
            "success"
          );

          // Chuy·ªÉn ƒë·∫øn trang ƒë∆°n h√†ng sau 1.5 gi√¢y
          setTimeout(() => {
            window.location.href = "orders.html";
          }, 1500);
        }
      }

      // ==========================================================================
      // MOMO QR PAYMENT - THANH TO√ÅN QU√âT QR MOMO (GI·∫¢ L·∫¨P)
      // Thi·∫øt k·∫ø d·ª±a tr√™n giao di·ªán thanh to√°n th·ª±c t·∫ø
      // ==========================================================================
      
      /**
       * Bi·∫øn l∆∞u th√¥ng tin thanh to√°n MoMo ƒëang x·ª≠ l√Ω
       * 
       * - formData: Th√¥ng tin form (ch∆∞a t·∫°o order)
       * - order: ƒê∆°n h√†ng (ch·ªâ t·∫°o khi thanh to√°n th√†nh c√¥ng)
       * - countdownInterval: ID c·ªßa setInterval ƒë·ªÉ d·ª´ng countdown
       * - remainingSeconds: S·ªë gi√¢y c√≤n l·∫°i
       * - step: B∆∞·ªõc hi·ªán t·∫°i (qr, processing, success)
       * - total: T·ªïng ti·ªÅn c·∫ßn thanh to√°n
       */
      let momoPaymentState = {
        formData: null,     // Th√¥ng tin form t·∫°m
        order: null,        // ƒê∆°n h√†ng (t·∫°o sau khi success)
        countdownInterval: null,
        remainingSeconds: 15,
        step: 'qr',
        total: 0
      };

      /**
       * Hi·ªÉn th·ªã modal thanh to√°n MoMo v·ªõi thi·∫øt k·∫ø m·ªõi
       * 
       * QUAN TR·ªåNG: Ch∆∞a t·∫°o ƒë∆°n h√†ng l√∫c n√†y!
       * Ch·ªâ l∆∞u formData v√† hi·ªán modal
       * ƒê∆°n h√†ng ƒë∆∞·ª£c t·∫°o khi thanh to√°n th√†nh c√¥ng
       * 
       * Layout 2 c·ªôt:
       * - C·ªôt tr√°i: Th√¥ng tin ƒë∆°n h√†ng
       * - C·ªôt ph·∫£i: QR Code v·ªõi logo MoMo ·ªü gi·ªØa
       * 
       * @param {Object} formData - Th√¥ng tin t·ª´ form checkout
       *   - customerInfo: { name, phone, address }
       *   - deliveryMethod: 'dine-in' | 'takeaway'
       *   - paymentMethod: 'qr'
       */
      function showMoMoPayment(formData) {
        // T√≠nh t·ªïng ti·ªÅn t·ª´ gi·ªè h√†ng (ch∆∞a t·∫°o order)
        const total = calculateTotal();
        
        // Ki·ªÉm tra gi·ªè h√†ng
        if (!total || total <= 0) {
          showNotification("Gi·ªè h√†ng tr·ªëng ho·∫∑c kh√¥ng h·ª£p l·ªá.", "error");
          return;
        }

        // Reset state - L∆ØU FORM DATA, CH∆ØA T·∫†O ORDER
        momoPaymentState.formData = formData;
        momoPaymentState.order = null;
        momoPaymentState.total = total;
        momoPaymentState.remainingSeconds = 15;
        momoPaymentState.step = 'qr';

        // ========== T·∫†O HTML CHO MODAL ==========
        const modalHTML = `
          <!-- 
            MOMO PAYMENT MODAL - Thi·∫øt k·∫ø m·ªõi
            - Backdrop blur effect
            - Header gradient h·ªìng v·ªõi countdown
            - Body 2 c·ªôt: th√¥ng tin + QR
            - Footer v·ªõi b·∫£o m·∫≠t
          -->
          <div id="momoBackdrop" class="modal-backdrop active" 
               style="background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);"
               onclick="cancelMoMoPayment()"></div>
          
          <div id="momoModal" class="modal active" style="
            max-width: 650px; 
            width: 95%;
            border-radius: 16px; 
            overflow: hidden;
            animation: zoomIn 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
          ">
            <!-- ========== HEADER v·ªõi gradient MoMo ========== -->
            <div style="
              background: linear-gradient(135deg, #a50064 0%, #d82d8b 100%);
              padding: 16px 24px;
              display: flex;
              align-items: center;
              justify-content: space-between;
              color: white;
            ">
              <!-- Logo MoMo + Text (b√™n tr√°i) -->
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="
                  width: 40px; 
                  height: 40px; 
                  background: white; 
                  border-radius: 10px; 
                  padding: 4px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                ">
                  <img src="https://cdn.brandfetch.io/momo.vn/w/512/h/512?c=1idiRamKWOLozA0BjjR" 
                       alt="MoMo" 
                       style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <span style="font-weight: 600; font-size: 16px;">Thanh to√°n MoMo</span>
              </div>
              
              <!-- Countdown Timer (gi·ªØa) -->
              <div id="momoTimerSection" style="
                display: flex;
                align-items: center;
                gap: 8px;
                background: rgba(255,255,255,0.15);
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 13px;
              ">
                <span>‚è±Ô∏è</span>
                <span>H·∫øt h·∫°n sau</span>
                <div style="display: flex; gap: 4px;">
                  <span id="momoMinutes" style="
                    background: rgba(255,255,255,0.25);
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-family: monospace;
                    font-weight: 600;
                  ">00</span>
                  <span>:</span>
                  <span id="momoSeconds" style="
                    background: rgba(255,255,255,0.25);
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-family: monospace;
                    font-weight: 600;
                  ">15</span>
                </div>
              </div>
              
              <!-- N√∫t ƒë√≥ng (b√™n ph·∫£i) -->
              <button onclick="cancelMoMoPayment()" style="
                background: transparent;
                border: none;
                color: white;
                cursor: pointer;
                padding: 8px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
              " onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                 onmouseout="this.style.background='transparent'">
                ‚úï
              </button>
            </div>
            
            <!-- ========== BODY - N·ªôi dung ch√≠nh ========== -->
            <div id="momoBody" style="padding: 24px; background: white;">
              <!-- QR Step Content -->
              <div id="momoQRContent" style="display: flex; gap: 24px; flex-wrap: wrap;">
                
                <!-- C·ªôt tr√°i: Th√¥ng tin ƒë∆°n h√†ng -->
                <div style="
                  flex: 1;
                  min-width: 200px;
                  background: #f8f9fa;
                  padding: 20px;
                  border-radius: 12px;
                ">
                  <h4 style="
                    margin: 0 0 16px 0;
                    color: #333;
                    font-size: 15px;
                    font-weight: 600;
                  ">üìã Th√¥ng tin ƒë∆°n h√†ng</h4>
                  
                  <div style="margin-bottom: 16px;">
                    <div style="color: #666; font-size: 13px; margin-bottom: 4px;">S·ªë ti·ªÅn thanh to√°n</div>
                    <div style="font-size: 24px; font-weight: 700; color: #a50064;">
                      ${formatCurrency(total)}
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <div style="color: #666; font-size: 13px; margin-bottom: 4px;">Gi√° tr·ªã ƒë∆°n h√†ng</div>
                    <div style="font-weight: 600; color: #a50064;">
                      ${formatCurrency(total)}
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <div style="color: #666; font-size: 13px; margin-bottom: 4px;">Ph√≠ giao d·ªãch</div>
                    <div style="font-weight: 600; color: #a50064;">0‚Ç´</div>
                  </div>
                  
                  <div>
                    <div style="color: #666; font-size: 13px; margin-bottom: 4px;">Tr·∫°ng th√°i</div>
                    <div style="font-weight: 600; color: #ff9800;">‚è≥ Ch·ªù thanh to√°n</div>
                  </div>
                </div>
                
                <!-- C·ªôt ph·∫£i: QR Code -->
                <div style="flex: 1; min-width: 200px; text-align: center;">
                  <h4 style="
                    margin: 0 0 16px 0;
                    color: #333;
                    font-size: 15px;
                    font-weight: 600;
                  ">üì± Qu√©t m√£ qua App MoMo</h4>
                  
                  <!-- QR Code Container v·ªõi Logo MoMo ·ªü gi·ªØa -->
                  <div style="
                    width: 180px;
                    height: 180px;
                    margin: 0 auto 16px;
                    background: linear-gradient(135deg, #fff0f5 0%, #ffe4ec 100%);
                    border: 2px solid #ffb3d0;
                    border-radius: 16px;
                    padding: 12px;
                    position: relative;
                  ">
                    <!-- QR Pattern gi·∫£ l·∫≠p -->
                    <div style="
                      width: 100%;
                      height: 100%;
                      background: white;
                      border-radius: 8px;
                      position: relative;
                      overflow: hidden;
                    ">
                      <!-- QR Grid Pattern -->
                      <div style="
                        position: absolute;
                        inset: 8px;
                        display: grid;
                        grid-template-columns: repeat(8, 1fr);
                        gap: 2px;
                      ">
                        ${Array(64).fill(0).map((_, i) => {
                          const isBlack = (i + Math.floor(i / 8)) % 3 === 0;
                          const isGray = (i + Math.floor(i / 8)) % 2 === 0;
                          return `<div style="
                            background: ${isBlack ? '#333' : isGray ? '#666' : '#fff'};
                            border-radius: 2px;
                          "></div>`;
                        }).join('')}
                      </div>
                      
                      <!-- Logo MoMo ·ªü gi·ªØa QR -->
                      <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 48px;
                        height: 48px;
                        background: white;
                        border-radius: 10px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        padding: 6px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      ">
                        <img src="https://cdn.brandfetch.io/momo.vn/w/512/h/512?c=1idiRamKWOLozA0BjjR" 
                             alt="MoMo" 
                             style="width: 100%; height: 100%; object-fit: contain;">
                      </div>
                    </div>
                  </div>
                  
                  <p style="color: #666; font-size: 14px; margin: 0 0 8px;">
                    M·ªü App <strong style="color: #a50064;">MoMo</strong> v√† qu√©t m√£ QR
                  </p>
                  <p id="momoCountdownText" style="color: #a50064; font-size: 13px; margin: 0;">
                    C√≤n <span id="momoCountdownDisplay">0:15</span> ƒë·ªÉ ho√†n t·∫•t...
                  </p>
                </div>
              </div>
              
              <!-- Processing State (·∫©n m·∫∑c ƒë·ªãnh) -->
              <div id="momoProcessingContent" style="display: none; text-align: center; padding: 48px 0;">
                <div style="
                  width: 64px;
                  height: 64px;
                  margin: 0 auto 24px;
                  border: 4px solid #f0f0f0;
                  border-top-color: #a50064;
                  border-radius: 50%;
                  animation: spin 1s linear infinite;
                "></div>
                <h3 style="margin: 0 0 8px; color: #333;">ƒêang x·ª≠ l√Ω thanh to√°n...</h3>
                <p style="margin: 0; color: #666;">Vui l√≤ng kh√¥ng t·∫Øt tr√¨nh duy·ªát</p>
              </div>
              
              <!-- Success State (·∫©n m·∫∑c ƒë·ªãnh) -->
              <div id="momoSuccessContent" style="display: none; text-align: center; padding: 48px 0;">
                <div style="
                  width: 80px;
                  height: 80px;
                  margin: 0 auto 24px;
                  background: #e8f5e9;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  animation: scaleIn 0.3s ease;
                ">
                  <span style="font-size: 40px;">‚úÖ</span>
                </div>
                <h3 style="margin: 0 0 8px; color: #333;">Thanh to√°n th√†nh c√¥ng!</h3>
                <p id="momoSuccessAmount" style="margin: 0; color: #666;">S·ªë ti·ªÅn: ${formatCurrency(total)}</p>
              </div>
              
              <!-- N√∫t h·ªßy (ch·ªâ hi·ªán ·ªü QR step) -->
              <div id="momoCancelBtn" style="text-align: center; margin-top: 20px;">
                <button onclick="cancelMoMoPayment()" style="
                  background: transparent;
                  border: 1px solid #ddd;
                  color: #666;
                  padding: 12px 32px;
                  border-radius: 12px;
                  font-size: 14px;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.borderColor='#a50064'; this.style.color='#a50064';"
                   onmouseout="this.style.borderColor='#ddd'; this.style.color='#666';">
                  H·ªßy thanh to√°n
                </button>
              </div>
            </div>
            
            <!-- ========== FOOTER ========== -->
            <div style="
              padding: 12px 24px;
              background: #f8f9fa;
              border-top: 1px solid #eee;
              display: flex;
              align-items: center;
              justify-content: space-between;
              font-size: 12px;
              color: #888;
            ">
              <div style="display: flex; align-items: center; gap: 6px;">
                <span>üîí</span>
                <span>Giao d·ªãch ƒë∆∞·ª£c b·∫£o m·∫≠t b·ªüi MoMo</span>
              </div>
              <span>¬© 2025 Kvone Coffee</span>
            </div>
          </div>
          
          <style>
            @keyframes spin {
              to { transform: rotate(360deg); }
            }
            @keyframes scaleIn {
              from { transform: scale(0); }
              to { transform: scale(1); }
            }
          </style>
        `;

        // Th√™m modal v√†o body
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // ========== B·∫ÆT ƒê·∫¶U COUNTDOWN ==========
        startMoMoCountdown();
      }

      /**
       * B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c 15 gi√¢y
       * 
       * C·∫≠p nh·∫≠t:
       * - Timer hi·ªÉn th·ªã MM:SS trong header
       * - Text countdown b√™n d∆∞·ªõi QR
       * - Khi h·∫øt 15s -> Chuy·ªÉn sang processing -> success
       */
      function startMoMoCountdown() {
        const minutesEl = document.getElementById('momoMinutes');
        const secondsEl = document.getElementById('momoSeconds');
        const countdownDisplay = document.getElementById('momoCountdownDisplay');
        
        if (!secondsEl) return;

        // ƒê·∫∑t interval ch·∫°y m·ªói gi√¢y
        momoPaymentState.countdownInterval = setInterval(() => {
          momoPaymentState.remainingSeconds--;
          
          const mins = Math.floor(momoPaymentState.remainingSeconds / 60);
          const secs = momoPaymentState.remainingSeconds % 60;
          
          // C·∫≠p nh·∫≠t timer trong header
          if (minutesEl) minutesEl.textContent = mins.toString().padStart(2, '0');
          if (secondsEl) secondsEl.textContent = secs.toString().padStart(2, '0');
          
          // C·∫≠p nh·∫≠t text countdown
          if (countdownDisplay) {
            countdownDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          }

          // H·∫øt th·ªùi gian -> Chuy·ªÉn sang processing
          if (momoPaymentState.remainingSeconds <= 0) {
            showMoMoProcessing();
          }
        }, 1000);
      }

      /**
       * Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang x·ª≠ l√Ω
       */
      function showMoMoProcessing() {
        momoPaymentState.step = 'processing';
        
        // D·ª´ng countdown
        if (momoPaymentState.countdownInterval) {
          clearInterval(momoPaymentState.countdownInterval);
          momoPaymentState.countdownInterval = null;
        }
        
        // ·∫®n QR content, hi·ªán processing
        const qrContent = document.getElementById('momoQRContent');
        const processingContent = document.getElementById('momoProcessingContent');
        const cancelBtn = document.getElementById('momoCancelBtn');
        const timerSection = document.getElementById('momoTimerSection');
        
        if (qrContent) qrContent.style.display = 'none';
        if (processingContent) processingContent.style.display = 'block';
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (timerSection) timerSection.style.display = 'none';
        
        // Sau 2 gi√¢y -> Hi·ªán success
        setTimeout(showMoMoSuccess, 2000);
      }

      /**
       * Hi·ªÉn th·ªã tr·∫°ng th√°i th√†nh c√¥ng
       */
      function showMoMoSuccess() {
        momoPaymentState.step = 'success';
        
        // ·∫®n processing, hi·ªán success
        const processingContent = document.getElementById('momoProcessingContent');
        const successContent = document.getElementById('momoSuccessContent');
        
        if (processingContent) processingContent.style.display = 'none';
        if (successContent) successContent.style.display = 'block';
        
        // Sau 1.5 gi√¢y -> Chuy·ªÉn trang ƒë∆°n h√†ng
        setTimeout(() => {
          completeMoMoPayment();
        }, 1500);
      }

      /**
       * Ho√†n t·∫•t thanh to√°n MoMo th√†nh c√¥ng
       * 
       * QUAN TR·ªåNG: ƒê√¢y l√† l√∫c T·∫†O ƒê∆†N H√ÄNG!
       * Tr∆∞·ªõc ƒë√≥ ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c t·∫°o
       */
      function completeMoMoPayment() {
        // ========== T·∫†O ƒê∆†N H√ÄNG KHI THANH TO√ÅN TH√ÄNH C√îNG ==========
        const formData = momoPaymentState.formData;
        
        if (!formData) {
          showNotification("L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng.", "error");
          closeMoMoModal();
          return;
        }
        
        // T·∫°o ƒë∆°n h√†ng t·ª´ formData ƒë√£ l∆∞u
        const result = createOrder(
          formData.customerInfo,
          formData.deliveryMethod,
          formData.paymentMethod
        );

        // ƒê√≥ng modal
        closeMoMoModal();

        if (!result.success) {
          showNotification(result.message, "error");
          return;
        }

        // L∆∞u order v√†o state ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o
        momoPaymentState.order = result.order;

        // Hi·ªán th√¥ng b√°o th√†nh c√¥ng
        showNotification(
          "‚úÖ Thanh to√°n MoMo th√†nh c√¥ng! M√£ ƒë∆°n: " + result.order.id,
          "success"
        );

        // Chuy·ªÉn ƒë·∫øn trang ƒê∆†N H√ÄNG
        setTimeout(() => {
          window.location.href = "orders.html";
        }, 500);
      }

      /**
       * H·ªßy thanh to√°n MoMo
       * 
       * QUAN TR·ªåNG: 
       * - KH√îNG t·∫°o ƒë∆°n h√†ng
       * - Ch·ªâ ƒë√≥ng modal
       * - Gi·ªØ nguy√™n trang checkout ƒë·ªÉ kh√°ch c√≥ th·ªÉ ch·ªçn ph∆∞∆°ng th·ª©c kh√°c
       */
      function cancelMoMoPayment() {
        // Kh√¥ng cho h·ªßy khi ƒëang processing ho·∫∑c success
        if (momoPaymentState.step === 'processing' || momoPaymentState.step === 'success') {
          return;
        }
        
        // D·ª´ng countdown
        if (momoPaymentState.countdownInterval) {
          clearInterval(momoPaymentState.countdownInterval);
          momoPaymentState.countdownInterval = null;
        }

        // ========== CH·ªà ƒê√ìNG MODAL, KH√îNG T·∫†O/H·ª¶Y ƒê∆†N H√ÄNG ==========
        /**
         * Khi ng∆∞·ªùi d√πng click "H·ªßy thanh to√°n":
         * - KH√îNG c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c t·∫°o (v√¨ ch∆∞a thanh to√°n th√†nh c√¥ng)
         * - ƒê√≥ng modal MoMo
         * - ·ªû l·∫°i trang checkout
         * - Kh√°ch h√†ng c√≥ th·ªÉ ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n kh√°c
         */

        // ƒê√≥ng modal
        closeMoMoModal();

        // Th√¥ng b√°o - c√≥ th·ªÉ ch·ªçn ph∆∞∆°ng th·ª©c kh√°c
        showNotification(
          "ƒê√£ h·ªßy thanh to√°n MoMo. B·∫°n c√≥ th·ªÉ ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n kh√°c.",
          "info"
        );

        // Reset state
        momoPaymentState.formData = null;
        momoPaymentState.order = null;
        momoPaymentState.step = 'qr';
        
        // KH√îNG chuy·ªÉn trang - ·ªü l·∫°i checkout ƒë·ªÉ ch·ªçn ph∆∞∆°ng th·ª©c kh√°c
      }

      /**
       * ƒê√≥ng modal MoMo
       */
      function closeMoMoModal() {
        const backdrop = document.getElementById('momoBackdrop');
        const modal = document.getElementById('momoModal');
        
        if (backdrop) backdrop.remove();
        if (modal) modal.remove();
      }
    </script>
  </body>
</html>
